<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Auto Prompt Creator</title>
    <style>
      :root { color-scheme: light dark; }
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .container { max-width: 900px; margin: 0 auto; padding: 24px; }
      header { display: flex; justify-content: space-between; align-items: center; }
      h1 { font-size: 20px; margin: 0; }
      .chat { border: 1px solid var(--border, #ccc); border-radius: 12px; overflow: hidden; margin-top: 16px; }
      .messages { height: 60vh; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
      .msg { padding: 12px 14px; border-radius: 10px; max-width: 80%; white-space: pre-wrap; }
      .msg.user { align-self: flex-end; background: #2b7fff22; border: 1px solid #2b7fff44; }
      .msg.assistant { align-self: flex-start; background: #9b59b622; border: 1px solid #9b59b644; }
      .msg.system { align-self: center; background: #6662; border: 1px dashed #6666; }
      form { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border, #ccc); }
      input, button, select { font: inherit; }
      input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #8886; }
      button { padding: 10px 14px; border-radius: 8px; border: 1px solid #8886; background: #2b7fff; color: white; }
      .toolbar { display: flex; gap: 8px; align-items: center; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Auto Prompt Creator</h1>
        <div class="toolbar">
          <label>
            Model key:
            <input id="modelKey" type="text" size="18" value="gemini-2.5-flash" />
          </label>
          <label>
            Thread:
            <input id="threadId" type="text" size="8" value="web-1" />
          </label>
          <button id="startBtn">Start</button>
          <button id="endBtn">End</button>
        </div>
      </header>

      <section class="chat">
        <div id="messages" class="messages"></div>
        <form id="form">
          <input id="input" type="text" placeholder="Type your message..." />
          <button>Send</button>
        </form>
      </section>
    </div>

    <script>
      const apiBase = (location.search.match(/api=([^&]+)/) || [])[1] ? decodeURIComponent((location.search.match(/api=([^&]+)/) || [])[1]) : 'http://localhost:8000';
      const messagesEl = document.getElementById('messages');
      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const modelKeyEl = document.getElementById('modelKey');
      const threadIdEl = document.getElementById('threadId');
      const startBtn = document.getElementById('startBtn');
      const endBtn = document.getElementById('endBtn');

      function addMsg(role, content) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.textContent = content;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function start() {
        const res = await fetch(`${apiBase}/api/start`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread_id: threadIdEl.value, model_key: modelKeyEl.value || null })
        });
        const data = await res.json();
        addMsg('system', 'Session started');
      }

      async function send(text) {
        const res = await fetch(`${apiBase}/api/message`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread_id: threadIdEl.value, content: text })
        });
        const data = await res.json();
        (data.messages || []).forEach(m => addMsg(m.role, m.content));
      }

      async function end() {
        await fetch(`${apiBase}/api/end`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread_id: threadIdEl.value })
        });
        addMsg('system', 'Session ended');
      }

      startBtn.addEventListener('click', () => start());
      endBtn.addEventListener('click', () => end());

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;
        addMsg('user', text);
        input.value = '';
        send(text);
      });
    </script>
  </body>
</html>
